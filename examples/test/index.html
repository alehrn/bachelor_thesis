<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Frame 3D Globe Component Example</title>
    <meta name="description" content="Example for 3D Globe component."></meta>

    <script src="//unpkg.com/d3"></script>

    <script src="//unpkg.com/aframe"></script>
    <script src="../../dist/aframe-globe-component.min.js"></script>
  </head>
  <body>
    <a-scene stats background="color: #001">
      <!-- Camera and button entity to follow camera -->
      <a-entity id="cameraRig" position="0 0 0">
        <a-camera look-controls="pointerLockEnabled: false" wasd-controls="fly: true; acceleration: 50;"></a-camera>
        <a-entity follow-camera>
          <a-entity id="buttons" position="-0.7 0.2 -1">
            <a-box id="startButton"
                   width="0.5"
                   height="0.2"
                   depth="0.1"
                   color="green"
                   text="value: Start Turning; align: center"
                   onclick="startTurning()">
            </a-box>
            <a-box id="stopButton"
                   position="0 -0.4 0"
                   width="0.5"
                   height="0.2"
                   depth="0.1"
                   color="red"
                   text="value: Stop Turning; align: center"
                   onclick="stopTurning()">
            </a-box>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity position="0 0 25">
        <a-entity cursor="rayOrigin: mouse; mouseCursorStylesEnabled: true;" raycaster="objects: [globe]; interval: 100"></a-entity>
        <a-entity laser-controls="hand: left" raycaster="objects: [globe]; interval: 100; lineColor: steelblue; lineOpacity: 0.85; "></a-entity>
        <a-entity laser-controls="hand: right" raycaster="objects: [globe]; interval: 100; lineColor: steelblue; lineOpacity: 0.85;"></a-entity>
        <a-entity id="globe" scale="0.1 0.1 0.1" globe="
          globe-image-url: //unpkg.com/three-globe/example/img/earth-night.jpg;
        "></a-entity>
      </a-entity>
    </a-scene>

    <script>
      const colorScale = d3.scaleSequentialSqrt(d3.interpolateYlOrRd);
      let rotating = true;

      // GDP per capita (avoiding countries with small pop)
      const getVal = feat => feat.properties.GDP_MD_EST / Math.max(1e5, feat.properties.POP_EST);

      AFRAME.registerComponent('follow-camera', {
        tick: function () {
          const cameraEl = document.querySelector('[camera]');
          const cameraRotation = cameraEl.getAttribute('rotation');
          this.el.setAttribute('rotation', cameraRotation);
        }
      });

      function startTurning() {
        rotating = true;
        document.getElementById('startButton').setAttribute('visible', 'false');
        document.getElementById('stopButton').setAttribute('visible', 'true');
      }

      function stopTurning() {
        rotating = false;
        document.getElementById('stopButton').setAttribute('visible', 'false');
        document.getElementById('startButton').setAttribute('visible', 'true');
      }

      fetch('../datasets/ne_110m_admin_0_countries.geojson').then(res => res.json()).then(countries =>
      {
        const maxVal = Math.max(...countries.features.map(getVal));
        colorScale.domain([0, maxVal]);

        const globeEntity = document.getElementById('globe');
        globeEntity.setAttribute('globe', {
          polygonsData: countries.features,
          polygonAltitude: 0.06,
          polygonSideColor: () => 'rgba(0, 100, 0, 0.15)',
          polygonStrokeColor: () => '#111',
          polygonCapColor: feat => colorScale(getVal(feat)),
          polygonsTransitionDuration: 300,
          onHover: hoverObj => {
            let label = '', desc = '';
            if (hoverObj && hoverObj.type === 'polygon') {
              const d = hoverObj.data.properties;
              label = `${d.ADMIN} (${d.ISO_A2})`;
              desc = `GDP: ${d.GDP_MD_EST} M$, Population: ${d.POP_EST}`
            }
            document.querySelector('#globe-tooltip').setAttribute('value', label);
            document.querySelector('#globe-tooltip-details').setAttribute('value', desc);

            globeEntity.setAttribute('globe', 'polygonAltitude', d => (hoverObj && d === hoverObj.data) ? 0.12 : 0.06);
            globeEntity.setAttribute('globe', 'polygonCapColor', d => (hoverObj && d === hoverObj.data) ? 'steelblue' : colorScale(getVal(d)));
          }
        });
      });
    </script>
  </body>
</html>
